name: Download Multiple Artifacts

on:
  workflow_dispatch:

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo B
        uses: actions/checkout@v4

      - name: Download latest artifacts by name
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.PUBLICTOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/ahmetdriveport/urlverileri/actions/artifacts \
            -o artifacts.json

          mkdir -p ./downloaded_artifacts

          for NAME in sektorpazar-excel vert-pdfk-excel horz-pdfk-excel \
                     main-indis-fiyat-results indis-indicators-results \
                     main-indis-profit-results profit-results \
                     fiyat-results indicators-results pivot-gaijin-excel; do
            echo "Checking latest artifact for $NAME"
            ID=$(jq -r --arg NAME "$NAME" '.artifacts | map(select(.name==$NAME)) | sort_by(.created_at) | last | .id' artifacts.json)

            if [ "$ID" != "null" ]; then
              curl -L \
                -H "Authorization: Bearer ${{ secrets.PUBLICTOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/ahmetdriveport/urlverileri/actions/artifacts/$ID/zip \
                -o artifact_$NAME.zip

              unzip -o artifact_$NAME.zip -d ./downloaded_artifacts/$NAME
            else
              echo "No artifact found for $NAME"
            fi
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas gspread google-auth openpyxl google-api-python-client

      - name: Create Google Credentials file
        env:
          CREDENTIALS: ${{ secrets.CREDENTIALS }}
        run: |
          python - << 'PY'
          import os, base64
          data = os.environ["CREDENTIALS"]
          decoded = base64.b64decode(data).decode("utf-8")
          with open("GOOGLE_CREDENTIALS_JSON","w",encoding="utf-8") as f:
              f.write(decoded)
          print("✅ GOOGLE_CREDENTIALS_JSON oluşturuldu.")
          PY

      - name: Run hisse_fiyat_indikator.py
        run: |
          python hisse_fiyat_indikator.py
